service: nugget

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: eu-west-1
  stage: ${opt:stage, 'dev'}
  apiGateway:
    shouldStartNameWithService: true
  environment:
    NUGGET_USERS_TABLE: ${self:service}-users-${self:provider.stage}
    NUGGET_NUGGETS_TABLE: ${self:service}-nuggets-${self:provider.stage}
    NUGGET_SESSIONS_TABLE: ${self:service}-sessions-${self:provider.stage}
    NUGGET_SCHEDULES_TABLE: ${self:service}-schedules-${self:provider.stage}
    NUGGET_DEVICE_TOKENS_TABLE: ${self:service}-device-tokens-${self:provider.stage}
    NUGGET_FEEDS_TABLE: ${self:service}-feeds-${self:provider.stage}
    NUGGET_FETCHED_ARTICLES_TABLE: ${self:service}-fetched-articles-${self:provider.stage}
    NUGGET_CUSTOM_DIGESTS_TABLE: ${self:service}-custom-digests-${self:provider.stage}
    NUGGET_SHARED_NUGGETS_TABLE: ${self:service}-shared-nuggets-${self:provider.stage}
    NUGGET_WAITLIST_TABLE: ${self:service}-waitlist-${self:provider.stage}
    NUGGET_FEEDBACK_TABLE: ${self:service}-feedback-${self:provider.stage}
    NUGGET_FEEDBACK_VOTES_TABLE: ${self:service}-feedback-votes-${self:provider.stage}
    NUGGET_CUSTOM_FEEDS_TABLE: ${self:service}-custom-feeds-${self:provider.stage}
    NUGGET_FRIEND_SHARED_NUGGETS_TABLE: ${self:service}-friend-shared-nuggets-${self:provider.stage}
    JWT_SECRET: ${env:JWT_SECRET, 'dev-secret-change-in-production'}
    STAGE: ${self:provider.stage}
    COGNITO_USER_POOL_ID: eu-west-1_1zILS9mOj
    COGNITO_CLIENT_ID: 6roa95ol200brl6tsrlnkckpd6
    USE_COGNITO: 'true'
    APPLE_CLIENT_ID: NuggetApp
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID, ''}
    IOS_PLATFORM_APPLICATION_ARN: ${env:IOS_PLATFORM_APPLICATION_ARN, 'arn:aws:sns:eu-west-1:851725413603:app/APNS_SANDBOX/NuggetApp-iOS-Sandbox'}
    ANDROID_PLATFORM_APPLICATION_ARN: ${env:ANDROID_PLATFORM_APPLICATION_ARN, ''}
    AWS_ACCOUNT_ID: ${aws:accountId}
    EVENTBRIDGE_SCHEDULER_ROLE_ARN: !GetAtt EventBridgeSchedulerRole.Arn
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt UsersTable.Arn
            - !GetAtt NuggetsTable.Arn
            - !GetAtt SessionsTable.Arn
            - !GetAtt SchedulesTable.Arn
            - !GetAtt DeviceTokensTable.Arn
            - !GetAtt FeedsTable.Arn
            - !GetAtt FetchedArticlesTable.Arn
            - !GetAtt CustomDigestsTable.Arn
            - !GetAtt SharedNuggetsTable.Arn
            - !GetAtt WaitlistTable.Arn
            - !GetAtt FeedbackTable.Arn
            - !GetAtt FeedbackVotesTable.Arn
            - !GetAtt CustomFeedsTable.Arn
            - !GetAtt FriendSharedNuggetsTable.Arn
            - !Sub '${NuggetsTable.Arn}/index/*'
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource:
            - 'arn:aws:bedrock:*::foundation-model/*'
            - 'arn:aws:bedrock:*:*:inference-profile/*'
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-summariseNugget'
            - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-autoFetchFeeds'
            - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-fetchFeedContentWorker'
        - Effect: Allow
          Action:
            - scheduler:CreateSchedule
            - scheduler:UpdateSchedule
            - scheduler:DeleteSchedule
            - scheduler:GetSchedule
          Resource:
            - !Sub 'arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/nugget-auto-process-*'
            - !Sub 'arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/nugget-feed-fetch-*'
        - Effect: Allow
          Action:
            - sns:CreatePlatformEndpoint
            - sns:DeleteEndpoint
            - sns:Publish
            - sns:GetEndpointAttributes
            - sns:SetEndpointAttributes
          Resource:
            - '*'
        - Effect: Allow
          Action:
            - iam:PassRole
          Resource:
            - !GetAtt EventBridgeSchedulerRole.Arn
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource:
            - '*'

functions:
  authApple:
    handler: dist/handlers/authApple.handler
    events:
      - httpApi:
          path: /v1/auth/apple
          method: post

  authMock:
    handler: dist/handlers/authMock.handler
    events:
      - httpApi:
          path: /v1/auth/mock
          method: post

  authCognito:
    handler: dist/handlers/authCognito.handler
    events:
      - httpApi:
          path: /v1/auth/cognito
          method: post

  authGoogle:
    handler: dist/handlers/authGoogle.handler
    events:
      - httpApi:
          path: /v1/auth/google
          method: post

  getMe:
    handler: dist/handlers/getMe.handler
    events:
      - httpApi:
          path: /v1/me
          method: get

  deleteUser:
    handler: dist/handlers/deleteUser.handler
    events:
      - httpApi:
          path: /v1/user
          method: delete

  createNugget:
    handler: dist/handlers/createNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets
          method: post

  listNuggets:
    handler: dist/handlers/listNuggets.handler
    events:
      - httpApi:
          path: /v1/nuggets
          method: get

  patchNugget:
    handler: dist/handlers/patchNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}
          method: patch

  deleteNugget:
    handler: dist/handlers/deleteNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}
          method: delete

  batchDeleteNuggets:
    handler: dist/handlers/batchDeleteNuggets.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/nuggets/batch-delete
          method: post

  startSession:
    handler: dist/handlers/startSession.handler
    events:
      - httpApi:
          path: /v1/sessions/start
          method: post

  createSmartSession:
    handler: dist/handlers/createSmartSession.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/sessions/smart
          method: post

  completeSession:
    handler: dist/handlers/completeSession.handler
    events:
      - httpApi:
          path: /v1/sessions/{sessionId}/complete
          method: post

  markNuggetsRead:
    handler: dist/handlers/markNuggetsRead.handler
    events:
      - httpApi:
          path: /v1/nuggets/mark-read
          method: post

  getSessionStatus:
    handler: dist/handlers/getSessionStatus.handler
    events:
      - httpApi:
          path: /v1/sessions/{sessionId}/status
          method: get

  getPreferences:
    handler: dist/handlers/getPreferences.handler
    events:
      - httpApi:
          path: /v1/preferences
          method: get

  updatePreferences:
    handler: dist/handlers/updatePreferences.handler
    events:
      - httpApi:
          path: /v1/preferences
          method: put

  processNuggets:
    handler: dist/handlers/processNuggets.handler
    timeout: 120
    events:
      - httpApi:
          path: /v1/nuggets/process
          method: post

  summariseNugget:
    handler: dist/handlers/summariseNugget.handler
    timeout: 60

  verifySubscription:
    handler: dist/handlers/verifySubscription.handler
    events:
      - httpApi:
          path: /v1/subscriptions/verify
          method: post

  shareNugget:
    handler: dist/handlers/shareNugget.handler
    timeout: 10
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}/share
          method: post

  getSharedNugget:
    handler: dist/handlers/shareNugget.getSharedNuggetHandler
    timeout: 10
    events:
      - httpApi:
          path: /v1/shared/{shareId}
          method: get

  setProcessingSchedule:
    handler: dist/handlers/setProcessingSchedule.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/processing/schedule
          method: post

  getProcessingSchedule:
    handler: dist/handlers/setProcessingSchedule.getScheduleHandler
    timeout: 30
    events:
      - httpApi:
          path: /v1/processing/schedule
          method: get

  autoProcessNuggets:
    handler: dist/handlers/autoProcessNuggets.handler
    timeout: 300
    # Invoked by EventBridge Scheduler - no HTTP events

  autoFetchFeeds:
    handler: dist/handlers/autoFetchFeeds.handler
    timeout: 300
    # Invoked by EventBridge Scheduler - no HTTP events

  registerDevice:
    handler: dist/handlers/registerDevice.handler
    events:
      - httpApi:
          path: /v1/device/register
          method: post

  testNotification:
    handler: dist/handlers/testNotification.handler
    events:
      - httpApi:
          path: /v1/notifications/test
          method: post

  getFeeds:
    handler: dist/handlers/getFeeds.handler
    events:
      - httpApi:
          path: /v1/feeds
          method: get

  subscribeFeed:
    handler: dist/handlers/subscribeFeed.handler
    events:
      - httpApi:
          path: /v1/feeds/subscribe
          method: post

  fetchFeedContent:
    handler: dist/handlers/fetchFeedContent.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/feeds/fetch
          method: post

  fetchFeedContentWorker:
    handler: dist/handlers/fetchFeedContentWorker.handler
    timeout: 300
    # No HTTP events - invoked async by fetchFeedContent

  triggerFeedFetch:
    handler: dist/handlers/triggerFeedFetch.handler
    timeout: 300
    events:
      - httpApi:
          path: /v1/feeds/fetch-all
          method: post

  manageDigests:
    handler: dist/handlers/manageDigests.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/digests
          method: post
      - httpApi:
          path: /v1/digests
          method: get
      - httpApi:
          path: /v1/digests/{digestId}
          method: put
      - httpApi:
          path: /v1/digests/{digestId}
          method: delete

  updateUserSettings:
    handler: dist/handlers/updateUserSettings.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/settings
          method: put

  getUserSettings:
    handler: dist/handlers/updateUserSettings.getSettingsHandler
    timeout: 30
    events:
      - httpApi:
          path: /v1/settings
          method: get

  contactForm:
    handler: dist/handlers/contactForm.handler
    timeout: 10
    environment:
      CONTACT_EMAIL: ${env:CONTACT_EMAIL, 'contact@nuggetdotcom.com'}
    events:
      - httpApi:
          path: /v1/contact
          method: post
      - httpApi:
          path: /v1/contact
          method: options

  getUsage:
    handler: dist/handlers/usage.handler
    events:
      - httpApi:
          path: /v1/usage
          method: get

  waitlist:
    handler: dist/handlers/waitlist.handler
    timeout: 10
    events:
      - httpApi:
          path: /v1/waitlist
          method: post
      - httpApi:
          path: /v1/waitlist
          method: options
      - httpApi:
          path: /v1/waitlist/admin
          method: get
      - httpApi:
          path: /v1/waitlist/admin/{email}
          method: put

  friends:
    handler: dist/handlers/friends.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/friends
          method: get
      - httpApi:
          path: /v1/friends/code
          method: get
      - httpApi:
          path: /v1/friends/add
          method: post
      - httpApi:
          path: /v1/friends/requests
          method: get
      - httpApi:
          path: /v1/friends/requests/{requestId}/accept
          method: post
      - httpApi:
          path: /v1/friends/requests/{requestId}/decline
          method: post
      - httpApi:
          path: /v1/friends/{friendId}
          method: delete

  feedback:
    handler: dist/handlers/feedback.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/feedback
          method: post
      - httpApi:
          path: /v1/feedback
          method: get
      - httpApi:
          path: /v1/feedback/{feedbackId}
          method: get
      - httpApi:
          path: /v1/feedback/{feedbackId}/vote
          method: post
      - httpApi:
          path: /v1/feedback/{feedbackId}
          method: put
      - httpApi:
          path: /v1/feedback
          method: options
      - httpApi:
          path: /v1/feedback/{feedbackId}
          method: options
      - httpApi:
          path: /v1/feedback/{feedbackId}/vote
          method: options

  customFeeds:
    handler: dist/handlers/customFeeds.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/feeds/custom
          method: post
      - httpApi:
          path: /v1/feeds/custom
          method: get
      - httpApi:
          path: /v1/feeds/custom/{feedId}
          method: delete
      - httpApi:
          path: /v1/feeds/custom/validate
          method: post

  shareToFriend:
    handler: dist/handlers/shareToFriend.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}/share-to-friends
          method: post
      - httpApi:
          path: /v1/shared-with-me
          method: get
      - httpApi:
          path: /v1/shared-with-me/{shareId}/read
          method: post

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH

    NuggetsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_NUGGETS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: nuggetId
            AttributeType: S
          - AttributeName: status
            AttributeType: S
          - AttributeName: priorityScore
            AttributeType: N
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: nuggetId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: UserStatusIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: status
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: UserPriorityIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: priorityScore
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_SESSIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: sessionId
            KeyType: RANGE

    SchedulesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_SCHEDULES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: scheduleId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: scheduleId
            KeyType: RANGE

    DeviceTokensTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_DEVICE_TOKENS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: deviceToken
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: deviceToken
            KeyType: RANGE

    FeedsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_FEEDS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: feedId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: feedId
            KeyType: RANGE

    FetchedArticlesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_FETCHED_ARTICLES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: articleId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: articleId
            KeyType: RANGE
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true

    CustomDigestsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_CUSTOM_DIGESTS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: digestId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: digestId
            KeyType: RANGE

    SharedNuggetsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_SHARED_NUGGETS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: shareId
            AttributeType: S
        KeySchema:
          - AttributeName: shareId
            KeyType: HASH
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true

    WaitlistTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_WAITLIST_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH

    FeedbackTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_FEEDBACK_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: feedbackId
            AttributeType: S
        KeySchema:
          - AttributeName: feedbackId
            KeyType: HASH

    FeedbackVotesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_FEEDBACK_VOTES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: feedbackId
            AttributeType: S
          - AttributeName: odinguserId
            AttributeType: S
        KeySchema:
          - AttributeName: feedbackId
            KeyType: HASH
          - AttributeName: odinguserId
            KeyType: RANGE

    CustomFeedsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_CUSTOM_FEEDS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: feedId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: feedId
            KeyType: RANGE

    FriendSharedNuggetsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_FRIEND_SHARED_NUGGETS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: recipientUserId
            AttributeType: S
          - AttributeName: shareId
            AttributeType: S
        KeySchema:
          - AttributeName: recipientUserId
            KeyType: HASH
          - AttributeName: shareId
            KeyType: RANGE

    # IAM role for EventBridge Scheduler to invoke Lambda
    EventBridgeSchedulerRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:service}-${self:provider.stage}-eventbridge-scheduler-role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: scheduler.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: InvokeLambda
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - lambda:InvokeFunction
                  Resource:
                    - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-autoProcessNuggets'
                    - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-autoFetchFeeds'

plugins:
  - serverless-offline
