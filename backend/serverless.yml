service: nugget

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: eu-west-1
  stage: ${opt:stage, 'dev'}
  apiGateway:
    shouldStartNameWithService: true
  environment:
    NUGGET_USERS_TABLE: ${self:service}-users-${self:provider.stage}
    NUGGET_NUGGETS_TABLE: ${self:service}-nuggets-${self:provider.stage}
    NUGGET_SESSIONS_TABLE: ${self:service}-sessions-${self:provider.stage}
    NUGGET_SCHEDULES_TABLE: ${self:service}-schedules-${self:provider.stage}
    NUGGET_DEVICE_TOKENS_TABLE: ${self:service}-device-tokens-${self:provider.stage}
    NUGGET_FEEDS_TABLE: ${self:service}-feeds-${self:provider.stage}
    JWT_SECRET: ${env:JWT_SECRET, 'dev-secret-change-in-production'}
    STAGE: ${self:provider.stage}
    COGNITO_USER_POOL_ID: eu-west-1_1zILS9mOj
    COGNITO_CLIENT_ID: 6roa95ol200brl6tsrlnkckpd6
    USE_COGNITO: 'true'
    APPLE_CLIENT_ID: NuggetApp
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID, ''}
    IOS_PLATFORM_APPLICATION_ARN: ${env:IOS_PLATFORM_APPLICATION_ARN, ''}
    ANDROID_PLATFORM_APPLICATION_ARN: ${env:ANDROID_PLATFORM_APPLICATION_ARN, ''}
    AWS_ACCOUNT_ID: ${aws:accountId}
    EVENTBRIDGE_SCHEDULER_ROLE_ARN: !GetAtt EventBridgeSchedulerRole.Arn
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt UsersTable.Arn
            - !GetAtt NuggetsTable.Arn
            - !GetAtt SessionsTable.Arn
            - !GetAtt SchedulesTable.Arn
            - !GetAtt DeviceTokensTable.Arn
            - !GetAtt FeedsTable.Arn
            - !Sub '${NuggetsTable.Arn}/index/*'
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource:
            - 'arn:aws:bedrock:*::foundation-model/*'
            - 'arn:aws:bedrock:*:*:inference-profile/*'
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-summariseNugget'
        - Effect: Allow
          Action:
            - scheduler:CreateSchedule
            - scheduler:UpdateSchedule
            - scheduler:DeleteSchedule
            - scheduler:GetSchedule
          Resource:
            - !Sub 'arn:aws:scheduler:${AWS::Region}:${AWS::AccountId}:schedule/default/nugget-auto-process-*'
        - Effect: Allow
          Action:
            - sns:CreatePlatformEndpoint
            - sns:DeleteEndpoint
            - sns:Publish
            - sns:GetEndpointAttributes
            - sns:SetEndpointAttributes
          Resource:
            - '*'
        - Effect: Allow
          Action:
            - iam:PassRole
          Resource:
            - !GetAtt EventBridgeSchedulerRole.Arn

functions:
  authApple:
    handler: dist/handlers/authApple.handler
    events:
      - httpApi:
          path: /v1/auth/apple
          method: post

  authMock:
    handler: dist/handlers/authMock.handler
    events:
      - httpApi:
          path: /v1/auth/mock
          method: post

  authCognito:
    handler: dist/handlers/authCognito.handler
    events:
      - httpApi:
          path: /v1/auth/cognito
          method: post

  authGoogle:
    handler: dist/handlers/authGoogle.handler
    events:
      - httpApi:
          path: /v1/auth/google
          method: post

  getMe:
    handler: dist/handlers/getMe.handler
    events:
      - httpApi:
          path: /v1/me
          method: get

  deleteUser:
    handler: dist/handlers/deleteUser.handler
    events:
      - httpApi:
          path: /v1/user
          method: delete

  createNugget:
    handler: dist/handlers/createNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets
          method: post

  listNuggets:
    handler: dist/handlers/listNuggets.handler
    events:
      - httpApi:
          path: /v1/nuggets
          method: get

  patchNugget:
    handler: dist/handlers/patchNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}
          method: patch

  deleteNugget:
    handler: dist/handlers/deleteNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}
          method: delete

  startSession:
    handler: dist/handlers/startSession.handler
    events:
      - httpApi:
          path: /v1/sessions/start
          method: post

  createSmartSession:
    handler: dist/handlers/createSmartSession.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/sessions/smart
          method: post

  completeSession:
    handler: dist/handlers/completeSession.handler
    events:
      - httpApi:
          path: /v1/sessions/{sessionId}/complete
          method: post

  getSessionStatus:
    handler: dist/handlers/getSessionStatus.handler
    events:
      - httpApi:
          path: /v1/sessions/{sessionId}/status
          method: get

  getPreferences:
    handler: dist/handlers/getPreferences.handler
    events:
      - httpApi:
          path: /v1/preferences
          method: get

  updatePreferences:
    handler: dist/handlers/updatePreferences.handler
    events:
      - httpApi:
          path: /v1/preferences
          method: put

  processNuggets:
    handler: dist/handlers/processNuggets.handler
    timeout: 120
    events:
      - httpApi:
          path: /v1/nuggets/process
          method: post

  summariseNugget:
    handler: dist/handlers/summariseNugget.handler
    timeout: 60

  verifySubscription:
    handler: dist/handlers/verifySubscription.handler
    events:
      - httpApi:
          path: /v1/subscriptions/verify
          method: post

  setProcessingSchedule:
    handler: dist/handlers/setProcessingSchedule.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/processing/schedule
          method: post

  autoProcessNuggets:
    handler: dist/handlers/autoProcessNuggets.handler
    timeout: 300
    # Invoked by EventBridge Scheduler - no HTTP events

  registerDevice:
    handler: dist/handlers/registerDevice.handler
    events:
      - httpApi:
          path: /v1/device/register
          method: post

  getFeeds:
    handler: dist/handlers/getFeeds.handler
    events:
      - httpApi:
          path: /v1/feeds
          method: get

  subscribeFeed:
    handler: dist/handlers/subscribeFeed.handler
    events:
      - httpApi:
          path: /v1/feeds/subscribe
          method: post

  fetchFeedContent:
    handler: dist/handlers/fetchFeedContent.handler
    timeout: 60
    events:
      - httpApi:
          path: /v1/feeds/fetch
          method: post

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH

    NuggetsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_NUGGETS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: nuggetId
            AttributeType: S
          - AttributeName: status
            AttributeType: S
          - AttributeName: priorityScore
            AttributeType: N
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: nuggetId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: UserStatusIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: status
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: UserPriorityIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: priorityScore
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_SESSIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: sessionId
            KeyType: RANGE

    SchedulesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_SCHEDULES_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: scheduleId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: scheduleId
            KeyType: RANGE

    DeviceTokensTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_DEVICE_TOKENS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: deviceToken
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: deviceToken
            KeyType: RANGE

    FeedsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_FEEDS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: feedId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: feedId
            KeyType: RANGE

    # IAM role for EventBridge Scheduler to invoke Lambda
    EventBridgeSchedulerRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:service}-${self:provider.stage}-eventbridge-scheduler-role
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: scheduler.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: InvokeLambda
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - lambda:InvokeFunction
                  Resource:
                    - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-autoProcessNuggets'

plugins:
  - serverless-offline
