service: nugget

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs18.x
  region: eu-west-1
  stage: ${opt:stage, 'dev'}
  apiGateway:
    shouldStartNameWithService: true
  environment:
    NUGGET_USERS_TABLE: ${self:service}-users-${self:provider.stage}
    NUGGET_NUGGETS_TABLE: ${self:service}-nuggets-${self:provider.stage}
    NUGGET_SESSIONS_TABLE: ${self:service}-sessions-${self:provider.stage}
    NUGGET_FEEDS_TABLE: ${self:service}-feeds-${self:provider.stage}
    JWT_SECRET: ${env:JWT_SECRET, 'dev-secret-change-in-production'}
    STAGE: ${self:provider.stage}
    COGNITO_USER_POOL_ID: eu-west-1_1zILS9mOj
    COGNITO_CLIENT_ID: 6roa95ol200brl6tsrlnkckpd6
    USE_COGNITO: 'true'
    APPLE_CLIENT_ID: NuggetApp
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID, ''}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchWriteItem
          Resource:
            - !GetAtt UsersTable.Arn
            - !GetAtt NuggetsTable.Arn
            - !GetAtt SessionsTable.Arn
            - !GetAtt FeedsTable.Arn
            - !Sub '${NuggetsTable.Arn}/index/*'
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource:
            - 'arn:aws:bedrock:*::foundation-model/*'
            - 'arn:aws:bedrock:*:*:inference-profile/*'
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - !Sub 'arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${self:service}-${self:provider.stage}-summariseNugget'

functions:
  authApple:
    handler: dist/handlers/authApple.handler
    events:
      - httpApi:
          path: /v1/auth/apple
          method: post

  authMock:
    handler: dist/handlers/authMock.handler
    events:
      - httpApi:
          path: /v1/auth/mock
          method: post

  authCognito:
    handler: dist/handlers/authCognito.handler
    events:
      - httpApi:
          path: /v1/auth/cognito
          method: post

  authGoogle:
    handler: dist/handlers/authGoogle.handler
    events:
      - httpApi:
          path: /v1/auth/google
          method: post

  getMe:
    handler: dist/handlers/getMe.handler
    events:
      - httpApi:
          path: /v1/me
          method: get

  deleteUser:
    handler: dist/handlers/deleteUser.handler
    events:
      - httpApi:
          path: /v1/user
          method: delete

  createNugget:
    handler: dist/handlers/createNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets
          method: post

  listNuggets:
    handler: dist/handlers/listNuggets.handler
    events:
      - httpApi:
          path: /v1/nuggets
          method: get

  patchNugget:
    handler: dist/handlers/patchNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}
          method: patch

  deleteNugget:
    handler: dist/handlers/deleteNugget.handler
    events:
      - httpApi:
          path: /v1/nuggets/{nuggetId}
          method: delete

  startSession:
    handler: dist/handlers/startSession.handler
    events:
      - httpApi:
          path: /v1/sessions/start
          method: post

  createSmartSession:
    handler: dist/handlers/createSmartSession.handler
    timeout: 30
    events:
      - httpApi:
          path: /v1/sessions/smart
          method: post

  completeSession:
    handler: dist/handlers/completeSession.handler
    events:
      - httpApi:
          path: /v1/sessions/{sessionId}/complete
          method: post

  getSessionStatus:
    handler: dist/handlers/getSessionStatus.handler
    events:
      - httpApi:
          path: /v1/sessions/{sessionId}/status
          method: get

  getPreferences:
    handler: dist/handlers/getPreferences.handler
    events:
      - httpApi:
          path: /v1/preferences
          method: get

  updatePreferences:
    handler: dist/handlers/updatePreferences.handler
    events:
      - httpApi:
          path: /v1/preferences
          method: put

  processNuggets:
    handler: dist/handlers/processNuggets.handler
    timeout: 120
    events:
      - httpApi:
          path: /v1/nuggets/process
          method: post

  summariseNugget:
    handler: dist/handlers/summariseNugget.handler
    timeout: 60

  getFeeds:
    handler: dist/handlers/getFeeds.handler
    events:
      - httpApi:
          path: /v1/feeds
          method: get

  subscribeFeed:
    handler: dist/handlers/subscribeFeed.handler
    events:
      - httpApi:
          path: /v1/feeds/subscribe
          method: post

  fetchFeedContent:
    handler: dist/handlers/fetchFeedContent.handler
    timeout: 60
    events:
      - httpApi:
          path: /v1/feeds/fetch
          method: post

resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_USERS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH

    NuggetsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_NUGGETS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: nuggetId
            AttributeType: S
          - AttributeName: status
            AttributeType: S
          - AttributeName: priorityScore
            AttributeType: N
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: nuggetId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: UserStatusIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: status
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: UserPriorityIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: priorityScore
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_SESSIONS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: sessionId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: sessionId
            KeyType: RANGE

    FeedsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.NUGGET_FEEDS_TABLE}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: feedId
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: feedId
            KeyType: RANGE

plugins:
  - serverless-offline
